<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Morphic - Test Suite</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

        <script type="module">
         import * as Morphic from './lib/morphic.mjs';

         class FailedTest {
             passed = false;
             bgColor = 'border-danger';
             constructor(test, memo) {
                 this.test = test;
                 this.memo = memo;
             }

             get message() { return this.memo ?? this.test }
         }

         class PassedTest {
             bgColor = 'border-success';
             passed = true;
             constructor(test, memo) {
                 this.test = test;
                 this.memo = memo;
             }

             get message() { return this.memo ?? this.test }
         }

         class ErroredTest {
             bgColor = 'border-warning';
             passed = null;
             constructor(error) {
                 this.error = error;
             }

             get message() {
                 return `${this.error.name}: ${this.error.message}\n${this.error.stack}`
             }
         }

         class TestCase {
             #currentTest;
             #passed;
             constructor(name = this.constructor.name) {
                 this.name = name;
                 this.id = name.replace(/\W/g, '-').toLowerCase();
                 this.assertions = [];
             }

             get passed() {
                 if (this.#passed !== undefined) {
                     return this.#passed;
                 }

                 const passing = this.assertions.every((a) => a.passed)
                 if (passing) return (this.#passed = true);

                 const errors = this.assertions.some((a) => a.passed === null);
                 if (errors) return (this.#passed = null);

                 return (this.#passed = false);
             }

             get bgColor() {
                 if (this.passed) return 'bg-success';
                 if (this.passed === null) return 'bg-warning';

                 return 'bg-danger';
             }

             prove() {
                 if (this.setup) this.setup();
                 const props = Object.getOwnPropertyNames(this.constructor.prototype).filter((prop) => prop.startsWith('test'));
                 for (const prop of props) {
                     try {
                         this.#currentTest = prop;
                         this[prop]()
                     } catch (e) {
                         if (e instanceof FailedTest || e instanceof PassedTest) {
                             this.assertions.push(e);
                         } else {
                             this.assertions.push(new ErroredTest(e));
                         }
                     }
                 }
                 if (this.teardown) this.teardown();
             }

             assert(value, memo = undefined) {
                 if (value !== true) { this.fail(memo) }
                 this.pass(memo);
             }

             fail(memo) {
                 throw new FailedTest(this.#currentTest, memo);
             }

             pass(memo) {
                 throw new PassedTest(this.#currentTest, memo);
             }
         }

         class AssertionsTest extends TestCase {
             testFalse() {
                 try {
                     this.assert(false);
                 } catch (e) {
                     if (e instanceof FailedTest) {
                         this.pass('false assersions fail');
                     }
                 }
             }

             testTrue() {
                 this.assert(true, 'true assersions pass');
             }
         }

         const tests = [new AssertionsTest()];
         tests.forEach((test) => { test.prove() });
         console.log('tests', tests);

         const body = Morphic.HTMLDocumentBodyMorph.new();
         body.tag('nav', { class: 'navbar navbar-light bg-light mb-2' })
             .tag('div', { class: 'container-fluid' })
             .tag('span', { class: 'navbar-brand mb-0 h1' }, "Morphic!");

         const main = body.tag('div', { class: 'container-fluid' });

         const stats = main.tag('div', { class: 'test-stats my-2' })
         stats.tag('span', { class: 'text-success' }, `(${tests.filter((t) => t.passed).length}) passed `);
         stats.tag('span', { class: 'text-danger' }, `(${tests.filter((t) => t.passed === false).length}) failed `);
         stats.tag('span', { class: 'text-warning' }, `(${tests.filter((t) => t.passed === null).length}) errored`);

         const accordion = main.tag('div', { class: 'accordion', id: 'morpic-test-suite' });
         tests.forEach((test) => {
             const item = accordion.tag('div', { class: ['accordion-item', test.bgColor] });
             item.tag('h2', { class: 'accordion-header' })
                 .tag('button', { class: 'accordion-button collapsed', type: 'button', 'data-bs-toggle': 'collapse', 'data-bs-target': `#${test.id}`, 'aria-expanded': false }, test.name);

             const content = item.tag('div', { id: test.id, class: 'accodion-collapse collapse', 'data-bs-parent': `#morphic-test-suite` })
                 .tag('div', { class: ['accordion-body', 'bg-white'] });

             const stats = content.tag('div', { class: 'my-2' })
             stats.tag('span', { class: 'text-success' }, `(${test.assertions.filter((t) => t.passed).length}) passed `);
             stats.tag('span', { class: 'text-danger' }, `(${test.assertions.filter((t) => t.passed === false).length}) failed `);
             stats.tag('span', { class: 'text-warning' }, `(${test.assertions.filter((t) => t.passed === null).length}) errored`);

             const list = content.tag('ul', { class: 'list-group' });
             test.assertions.forEach((assertion) => {
                 list.tag('li', { class: ['list-group-item', assertion.bgColor] }, assertion.message);
             });
         });

         body.draw();
        </script>
    </head>
</html>
